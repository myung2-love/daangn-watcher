<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>당근마켓 스캔</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body {
    background-color: #FFF7ED;
    font-family: 'Nanum Gothic', 'Roboto', sans-serif;
  }
  .keyword-chip {
    background: linear-gradient(90deg, #FB923C, #F97316);
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 9999px;
    margin: 0.25rem;
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .keyword-chip:hover { transform: scale(1.05); }
</style>
</head>
<body class="min-h-screen p-8 flex justify-center items-start">

<div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8 space-y-6">
  <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 text-center mb-8 transform hover:scale-105 transition-transform">
    🥕 당근마켓 스캔
  </h1>

  <!-- 검색 방식 선택 -->
  <div>
    <label class="block text-gray-700 font-semibold mb-2">검색 방식</label>
    <div class="flex space-x-4">
      <button id="btn-scan" type="button" onclick="selectSearchType('scan')"
              class="flex-1 py-3 rounded-xl border border-orange-400 bg-orange-100 text-orange-700 font-semibold transition transform hover:scale-105">
        일회성 검색
      </button>
      <button id="btn-watch" type="button" onclick="selectSearchType('watch')"
              class="flex-1 py-3 rounded-xl border border-gray-300 bg-gray-100 text-gray-700 font-semibold transition transform hover:scale-105">
        모니터링 검색
      </button>
    </div>
  </div>

  <!-- 시/도 선택 -->
  <div>
    <label for="city-select" class="block text-gray-700 font-semibold mb-2">시/도 선택</label>
    <div class="relative">
      <select id="city-select"
              class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-400 appearance-none">
        <option value="">선택</option>
        {% for city in locations.keys() %}
          <option value="{{ city }}">{{ city }}</option>
        {% endfor %}
      </select>
      <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- 키워드 입력 -->
  <div>
    <label class="block text-gray-700 font-semibold mb-2">검색 키워드</label>
    <div class="flex shadow-sm rounded-xl overflow-hidden border border-gray-300">
      <input type="text" id="keyword-input" placeholder="키워드 입력" class="flex-1 px-4 py-3 focus:outline-none">
      <button type="button" onclick="addKeyword()"
              class="bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white px-5 font-semibold">
        추가
      </button>
    </div>
    <div id="keywords-list" class="mt-3 flex flex-wrap"></div>
  </div>

  <!-- 가격 입력 -->
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label for="min-price-input" class="block text-gray-700 font-semibold mb-2">최소 가격</label>
      <input id="min-price-input" type="number" placeholder="최소 가격" min="0"
             class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-400">
    </div>
    <div>
      <label for="max-price-input" class="block text-gray-700 font-semibold mb-2">최대 가격</label>
      <input id="max-price-input" type="number" placeholder="최대 가격" min="0"
             class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-400">
    </div>
  </div>

  <!-- 조회 기간 (일회성 검색 전용) -->
  <div id="days-input-container">
    <label for="days-input" class="block text-gray-700 font-semibold mb-2">조회 기간(일)</label>
    <input id="days-input" type="number" placeholder="조회 기간(일)" value="1" min="1"
           class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-400">
  </div>

  <!-- 검색 버튼 -->
  <div>
    <button id="search-btn" type="button"
            class="w-full py-3 bg-gradient-to-r from-orange-400 to-orange-500 text-white font-bold rounded-2xl shadow-lg transition transform hover:scale-105">
      검색 실행
    </button>
  </div>

  <!-- 활성 모니터링 목록 -->
  <div>
    <label class="block text-gray-700 font-semibold mb-4 text-lg">활성 모니터링</label>
    <div id="active-watches" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

</div>

<script>
let currentType = 'scan';
let keywords = [];

function selectSearchType(type) {
  currentType = type;
  const btnScan = document.getElementById('btn-scan');
  const btnWatch = document.getElementById('btn-watch');
  const daysContainer = document.getElementById('days-input-container');
  const searchBtn = document.getElementById('search-btn');

  if(type === 'scan') {
    btnScan.className = "flex-1 py-3 rounded-xl border border-orange-400 bg-orange-100 text-orange-700 font-semibold transition transform hover:scale-105";
    btnWatch.className = "flex-1 py-3 rounded-xl border border-gray-300 bg-gray-100 text-gray-700 font-semibold transition transform hover:scale-105";
    daysContainer.style.display = 'block';
    searchBtn.className = "w-full py-3 bg-gradient-to-r from-orange-400 to-orange-500 text-white font-bold rounded-2xl shadow-lg transition transform hover:scale-105";
    searchBtn.onclick = runScan;
  } else {
    btnScan.className = "flex-1 py-3 rounded-xl border border-gray-300 bg-gray-100 text-gray-700 font-semibold transition transform hover:scale-105";
    btnWatch.className = "flex-1 py-3 rounded-xl border border-green-400 bg-green-100 text-green-700 font-semibold transition transform hover:scale-105";
    daysContainer.style.display = 'none';
    searchBtn.className = "w-full py-3 bg-gradient-to-r from-green-400 to-green-500 text-white font-bold rounded-2xl shadow-lg transition transform hover:scale-105";
    searchBtn.onclick = runWatch;
  }
}

function addKeyword() {
  const input = document.getElementById("keyword-input");
  const val = input.value.trim();
  if(val && !keywords.includes(val)) keywords.push(val);
  renderKeywords();
  input.value = "";
  input.focus();
}

function renderKeywords() {
  const container = document.getElementById("keywords-list");
  container.innerHTML = "";
  keywords.forEach(k => {
    const chip = document.createElement("span");
    chip.className = "keyword-chip flex items-center space-x-1";
    const text = document.createElement("span");
    text.textContent = k;
    const close = document.createElement("button");
    close.innerHTML = "&times;";
    close.className = "ml-2 text-white font-bold focus:outline-none";
    close.onclick = () => removeKeyword(k);
    chip.appendChild(text);
    chip.appendChild(close);
    container.appendChild(chip);
  });
}

function removeKeyword(k) {
  keywords = keywords.filter(kw => kw !== k);
  renderKeywords();
}

document.getElementById("keyword-input").addEventListener("keydown", function(e) {
  if(e.key === "Enter") { e.preventDefault(); addKeyword(); }
});

async function runScan() {
  const city = document.getElementById("city-select").value;
  const days = document.getElementById("days-input").value;
  const minPrice = document.getElementById("min-price-input").value;
  const maxPrice = document.getElementById("max-price-input").value;

  if(!city || keywords.length === 0) { alert("시/도와 키워드를 입력하세요."); return; }

  for(const kw of keywords) {
    const payload = { location: city, keyword: kw, days: parseInt(days) };
    if(minPrice) payload.min_price = parseInt(minPrice);
    if(maxPrice) payload.max_price = parseInt(maxPrice);
    const res = await fetch("/scan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log("SCAN 결과:", data);
  }
  alert("일회성 검색이 실행되었습니다.");
  resetForm();
}

async function runWatch() {
  const city = document.getElementById("city-select").value;
  const minPrice = document.getElementById("min-price-input").value;
  const maxPrice = document.getElementById("max-price-input").value;

  if(!city || keywords.length === 0) { alert("시/도와 키워드를 입력하세요."); return; }

  for(const kw of keywords) {
    const payload = { location: city, keyword: kw };
    if(minPrice) payload.min_price = parseInt(minPrice);
    if(maxPrice) payload.max_price = parseInt(maxPrice);

    const res = await fetch("/watch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log("WATCH 결과:", data);
  }
  loadActiveWatches();
  resetForm();
}

function resetForm() {
  document.getElementById("city-select").value = "";
  document.getElementById("days-input").value = 1;
  document.getElementById("min-price-input").value = "";
  document.getElementById("max-price-input").value = "";
  keywords = [];
  renderKeywords();
}

async function stopWatch(city, keyword) {
  const payload = { location: city, keyword: keyword };
  const res = await fetch("/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  console.log("STOP 결과:", data);
  loadActiveWatches();
}

async function loadActiveWatches() {
  const res = await fetch("/active");
  const data = await res.json();
  const container = document.getElementById("active-watches");
  container.innerHTML = "";

  Object.entries(data).forEach(([key, info]) => {
    const card = document.createElement("div");
    card.className = "flex flex-col justify-between p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transition-transform transform hover:scale-105 space-y-2";

    // 상단: 시/도 + 키워드
    const topRow = document.createElement("div");
    topRow.className = "flex justify-between items-center";
    const title = document.createElement("span");
    title.className = "font-medium text-gray-800";
    title.textContent = `${info.location} - ${info.keyword}`;
    topRow.appendChild(title);

    // 하단: 최소/최대 가격 표시
    const priceRow = document.createElement("div");
    priceRow.className = "text-sm text-gray-500";
    const minPriceText = (info.min_price !== null && info.min_price !== undefined) ? `최소: ${info.min_price}원` : "최소: -";
    const maxPriceText = (info.max_price !== null && info.max_price !== undefined) ? `최대: ${info.max_price}원` : "최대: -";
    priceRow.textContent = `${minPriceText} / ${maxPriceText}`;

    // 중지 버튼
    const btn = document.createElement("button");
    btn.className = "mt-2 px-4 py-2 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition self-end";
    btn.textContent = "중지";
    btn.onclick = async () => {
        await stopWatch(info.location, info.keyword, info.min_price, info.max_price);
        card.remove(); // 클릭 즉시 카드 제거
    };

    card.appendChild(topRow);
    card.appendChild(priceRow);
    card.appendChild(btn);

    container.appendChild(card);
  });
}

window.onload = () => { selectSearchType(currentType); loadActiveWatches(); };
</script>

</body>
</html>

